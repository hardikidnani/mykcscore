<!DOCTYPE html>
<html lang="en">
  <head>
  	<meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="http://d3js.org/d3.v3.min.js"></script>
	<script type="text/javascript" src="//cdn.jsdelivr.net/jquery/1/jquery.min.js"></script>
	<script type="text/javascript" src="//cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
	<script type="text/javascript" src="//cdn.jsdelivr.net/bootstrap.daterangepicker/2/daterangepicker.js"></script>
	<link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/bootstrap.daterangepicker/2/daterangepicker.css" />
	<link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/bootstrap/latest/css/bootstrap.css" /> 
	<script>window.jQuery || document.write('<script src="{{url_for('static', filename='jquery.js') }}">\x3C/script>')</script>
	<script type=text/javascript> $SCRIPT_ROOT = {{ request.script_root|tojson|safe }}; </script>
<style type="text/css">

html, body, div, span, applet, object, iframe,
h1, h2, h3, h4, h5, h6, p, blockquote, pre,
a, abbr, acronym, address, big, cite, code,
del, dfn, em, img, ins, kbd, q, s, samp,
small, strike, strong, sub, sup, tt, var,
b, u, i, center,
dl, dt, dd, ol, ul, li,
fieldset, form, label, legend,
table, caption, tbody, tfoot, thead, tr, th, td,
article, aside, canvas, details, embed, 
figure, figcaption, footer, header, hgroup, 
menu, nav, output, ruby, section, summary,
time, mark, audio, video {
  margin: 0;
  padding: 0;
  border: 0;
  font: inherit;
  font-size: 100%;
  vertical-align: baseline;
   font-family: "Helvetica Neue", Helvetica, Arial, "Lucida Grande", sans-serif; 
   font-weight: inherit;
}

h1 {
  font-size:150%;
   font-family: "HelveticaNeue-Light", "Helvetica Neue Light", "Helvetica Neue", Helvetica, Arial, "Lucida Grande", sans-serif; 
   font-weight: 300;
  text-align: left;
  margin-top: 5px;
  margin-bottom: 5px;
}
h2 {
  font-size: 12px;
  font-style: italic;
  color: gray;
  margin-top:5px;
  margin-bottom:5px;
}
#everything{
  width:600px;
  margin:20px;
}
#chart{
  width:600px;
  height:400px;
}
.bar{
  fill: lightskyblue;
}
text.label{
  fill: #777777;
  color: #777777;
  font-size: 20px;
  font-weight: bold;
}
text.category{
  fill: #666666;
  font-size: 14px;
}


</style>
	<title> Client Scoring </title>
</head>
<script type="text/javascript">

window.onload=function(){
  document.getElementById("runscore").style.display='none';

}
$(document).ready(function() {
			loadClients();
		})
		
		loadClients = function(){
			$.ajax({
				type: 'GET',
				url: '/clients',
				success: generateClientDropdown
			})
		}
		
generateClientDropdown = function(result) {
		var html = '';
			$('#clients').html('<option>Choose a client<option>');
			for (var i=0; i < result.results.items.length; i++) {
				var clientObj = result.results.items[i];
				$('#clients').html($('#clients').html() + '<option value="' + clientObj.id + '">' + clientObj.name + '</option>');
			}
			
			$('#clients').change(function() {
				var option = $(this).find('option:selected').val();
				$('#profiles-container').html('<select id="profiles" class="form-control"><option>Loading profiles...</option></select>');
				$.ajax({
					type: 'GET',
					url: '/profile',
					data:{'clientid':option},
					success: [generateProfileDropdown]
				});
			});
		}
		
generateProfileDropdown = function(result) {
			var html = '';
			$('#profiles').html('<option>Choose a profile</option>');
			for (var i=0; i < result.results.items.length; i++) {
				var profileObj = result.results.items[i];
				$('#profiles').html($('#profiles').html() + '<option value="' + profileObj.accountId + '">'+ profileObj.name + '</option>');
				//console.log(profileObj);
			}
			
			$('#profiles').change(function() {
				var option = $(this).find('option:selected').val();
				$('#views-container').html('<select id="views" class="form-control"><option>Loading views...</option></select>');
				$.ajax({
					url: '/views',
					data: {'dprofile':profileObj.accountId,'wp':profileObj.id},
					type: 'GET',
					success: [generateViewDropdown]
				});
			});			
		}


generateViewDropdown = function(result) {
			var html = '';
			$('#views').html('<option>Choose a View</option>');
			for (var i=0; i < result.results.items.length; i++) {
				var viewObj = result.results.items[i];

				$('#views').html($('#views').html() + '<option value="' + viewObj.id + '">' + viewObj.name + '</option>');
      }

      $('#views').change(function(){
        console.log("trial");
        $("#runscore").show();
      });


	 }

$(function() {

    var start = moment().subtract(29, 'days');
    var end = moment();

    function cb(start, end) {
        $('#reportrange span').html(start.format('YYYY-MM-DD') + ' - ' + end.format('YYYY-MM-DD'));
         var startd = start.format('YYYY-MM-DD');
         var endd = end.format('YYYY-MM-DD');
    }

    $('#reportrange').daterangepicker({
        startDate: start,
        endDate: end,
        ranges: {
           'Today': [moment(), moment()],
           'Yesterday': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
           'Last 7 Days': [moment().subtract(6, 'days'), moment()],
           'Last 30 Days': [moment().subtract(29, 'days'), moment()],
           'This Month': [moment().startOf('month'), moment().endOf('month')],
           'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]
        }
    }, cb);

    cb(start, end);
    
});

		
generateScoresTable = function(result) {
			var html = '<table id="scores-table"><tr><th>Page</th><th>Score</th></tr></br>';
			var parsed=JSON.parse(result.results);
			//html +='<p>'+parsed.length+'</p>';
			for (var i = 0; i < parsed.length; i++) {
				var scoreObj = parsed[i];
				html += '<tr><td>' + scoreObj.pageTitle + '</td><td>' + scoreObj.oms + '</td></tr>';
			}
			html+= '</table>';
			$('#scores-container').html(html);
		}


function benchmark(){


	var bstartd = moment(startd);
                bstartd.add(-90,'days');
              bstartd.format("YYYY-MM-DD");

	var bendd = moment(endd);
                bendd.add(-1,'days');
                bendd.format("YYYY-MM-DD");
}

function runscore(result) {
 
var html = '';
				var viewid=document.getElementById("views").value;
       // var data=JSON.parse(result.results);
        //console.log(viewid);
				var dateRange = document.getElementById("rangeValue").innerHTML;
                var split = dateRange.split(" - ");
                var startd = split[0].trim();
                var endd = split[1].trim();
             	
				var bstartd = moment(startd);
                bstartd.add(-90,'days');
              	bstartd.format("YYYY-MM-DD");
              	//console.log(bstartd);
              	var bs=bstartd.format("YYYY-MM-DD");
              	//console.log(bs);

				var bendd = moment(endd);
                bendd.add(-1,'days');
                bendd.format("YYYY-MM-DD");
                var be=bendd.format("YYYY-MM-DD");
                //console.log(be);
                //console.log(bendd);
          var proc = new Date().getTime();
				$('#scores-container').html('Loading scores...');
				$.ajax({
					url: '/prog',
					data: {'profileid':viewid,'bstartd':bs,'bendd':be,'startd':startd,'endd':endd},
					type: 'GET',
					success: [generateScoresTable,generated2graph]
           

				});	

}

var proc = new Date().getTime();
function AJAXSuccessFunction() {
    console.log(new Date().getTime() - proc);
}



generategraph= function(result){



var data=JSON.parse(result.results);
//console.log(data);



 //var data=JSON.parse(result.results);
var margin = {top: 20, right: 20, bottom: 30, left: 10},
    width = 960 - margin.left - margin.right,
    height = 500 - margin.top - margin.bottom;
    

var x = d3.scale.ordinal() 
    .rangeRoundBands([0, width], .1);

var y = d3.scale.linear()
    .range([height, 0]);

var xAxis = d3.svg.axis()
    .scale(x)
    .orient("bottom");

//var yAxis = d3.svg.axis()
  //  .scale(y)
    //.orient("left")
    //.ticks(7,"");

data.forEach(function(d){

  d.oms =+ d.oms;
});
var svg = d3.select("#d3-container").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
  .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");


      x.domain(data.map(function(d) { return d.pageTitle; }));
      y.domain([0, d3.max(data, function(d) { return d.oms; })]);

      svg.selectAll("bar")
      .data(data)
    .enter().append("rect")
      .attr("class", "bar")
      .attr("x", function(d) { return x(d.pageTitle); })
      .attr("width", x.rangeBand())
      .attr("y", function(d) { return y(d.oms); })
      .attr("height", function(d) { return height - y(d.oms); })


      svg.selectAll(".bartext")
     .data(data)
     .enter()
      .append("text")
      .attr("class", "bartext")
      .attr("text-anchor", "middle")
      .attr("fill", "white")
      .attr("x", function(d,i) {
      return x(d.pageTitle)+x.rangeBand()/2;
      })
      .attr("y", function(d,i) {
        return y(d.oms) + 15;
      })
    .text(function(d){
    return d.oms
        
    });

  


   /*   svg.append("g")
  .attr("class", "x axis")
     .attr("transform", "translate(0," + height + ")")
      .call(xAxis); */


  /*svg.append("g")
    .attr("class", "y axis")
    .call(yAxis)
    .append("text") // just for the title (ticks are automatic)
    .attr("transform", "rotate(-90)") // rotate the text!
    .attr("y", 6)
    .attr("dy", ".71em")
    .style("text-anchor", "end")
    .text("One Metric Score");*/



function type(d) {
  d.oms = +d.oms;
  return d;
   }


d3.select("#random")
      .on("click",function(){
      alert("Hello");
      svg.selectAll("rect")
      .data(data)
      .attr("y", function(d) { return y(d.oms); })
      .attr("height", function(d) { return height - y(d.oms); })

      });


}

  
function updateData(result)
{ 


  var bars = svg.selectAll(".bar").data(data, function(d) { return d.pageTitle; });

   bars.enter().append("rect")
    .attr("class", "bar")
    .attr("x", function(d) { return x(d.pageTitle); })
    .attr("width", x.rangeBand())
    .attr("y", function(d) { return y(d['One Metric Score']); })
    .attr("height", function(d) { return height - y(d['One Metric Score']); });

  bars.exit().remove();

  bar
    .attr("y", function(d) { return y(d['One Metric Score']); })
    .attr("height", function(d) { return height - y(d['One Metric Score']); });


  svg.select(".y.axis").remove();

   svg.append("g")
    .attr("class", "y axis")
    .call(yAxis)
    .append("text") // just for the title (ticks are automatic)
    .attr("transform", "rotate(-90)") // rotate the text!
    .attr("y", 6)
    .attr("dy", ".71em")
    .style("text-anchor", "end")
    .text("One Metric Score");

  bars
   .transition().duration(750)
    .attr("y", function(d) { return y(d['One Metric Score']); })
    .attr("height", function(d) { return height - y(d['One Metric Score']); });


 //console.log("trial");

  /*var data=JSON.parse(result.results);
   x.domain(data.map(function(d) { return d.pageTitle; }));
   y.domain([0, d3.max(data, function(d) { return d['One Metric Score']; })]);

   svg.select('.x.axis').transition().duration(300).call(xAxis);
   svg.select(".y.axis").transition().duration(300).call(yAxis)

   var bars = svg.selectAll(".bar").data(data, function(d) { return d.pageTitle; })

   bars.exit()
    .transition()
    .duration(300)
    .attr("y", y(0))
    .attr("height", height - y(0))
    .style('fill-opacity', 1e-6)
    .remove();


   bars.enter().append("rect")
    .attr("class", "bar")
    .attr("y", y(0))
    .attr("height", height - y(0));

    bars.transition().duration(300).attr("x", function(d) { return x(d.pageTitle); }) // (d) is one item from the data array, x is the scale object from above
    .attr("width", x.rangeBand()) // constant, so no callback function(d) here
    .attr("y", function(d) { return y(d['One Metric Score']); })
    .attr("height", function(d) { return height - y(d['One Metric Score']); });*/
    //updateData();


}

generated2graph=function(result){
  console.log(new Date().getTime() - proc);
  var setup = function(targetID){
  //Set size of svg element and chart
  var margin = {top: 0, right: 0, bottom: 0, left: 0},
    width = 600 - margin.left - margin.right,
    height = 400 - margin.top - margin.bottom,
    categoryIndent = 4*15 + 5,
    defaultBarWidth = 2000;

  //Set up scales
  var x = d3.scale.linear()
    .domain([0,defaultBarWidth])
    .range([0,width]);
  var y = d3.scale.ordinal()
    .rangeRoundBands([0, height], 0.1, 0);

  //Create SVG element
  d3.select(targetID).selectAll("svg").remove()
  var svg = d3.select(targetID).append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
    .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
  
  //Package and export settings
  var settings = {
    margin:margin, width:width, height:height, categoryIndent:categoryIndent,
    svg:svg, x:x, y:y
  }
  return settings;
}

var redrawChart = function(targetID, newdata) {

  //Import settings
  var margin=settings.margin, width=settings.width, height=settings.height, categoryIndent=settings.categoryIndent, 
  svg=settings.svg, x=settings.x, y=settings.y;

  //Reset domains
  y.domain(newdata.sort(function(a,b){
    return b.oms - a.oms;
  })
    .map(function(d) { return d.pageTitle; }));
  var barmax = d3.max(newdata, function(e) {
    return e.oms;
  });
  x.domain([0,barmax]);

  /////////
  //ENTER//
  /////////

  //Bind new data to chart rows 

  //Create chart row and move to below the bottom of the chart
  var chartRow = svg.selectAll("g.chartRow")
    .data(newdata, function(d){ return d.pageTitle});
  var newRow = chartRow
    .enter()
    .append("g")
    .attr("class", "chartRow")
    .attr("transform", "translate(0," + height + margin.top + margin.bottom + ")");

  //Add rectangles
  newRow.insert("rect")
    .attr("class","bar")
    .attr("x", 0)
    .attr("opacity",0)
    .attr("height", y.rangeBand())
    .attr("width", function(d) { return x(d.oms);}) 

  //Add value labels
  newRow.append("text")
    .attr("class","label")
    .attr("y", y.rangeBand()/2)
    .attr("x",0)
    .attr("opacity",0)
    .attr("dy",".35em")
    .attr("dx","0.5em")
    .text(function(d){return d.oms;}); 
  
  //Add Headlines
  newRow.append("text")
    .attr("class","category")
    .attr("text-overflow","ellipsis")
    .attr("y", y.rangeBand()/2)
    .attr("x",categoryIndent)
    .attr("opacity",0)
    .attr("dy",".35em")
    .attr("dx","0.5em")
    .text(function(d){return d.pageTitle});


  //////////
  //UPDATE//
  //////////
  
  //Update bar widths
  chartRow.select(".bar").transition()
    .duration(300)
    .attr("width", function(d) { return x(d.oms);})
    .attr("opacity",1);

  //Update data labels
  chartRow.select(".label").transition()
    .duration(300)
    .attr("opacity",1)
    .tween("text", function(d) { 
    var i = d3.interpolate(+this.textContent.replace(/\,/g,''), +d.oms);
    return function(t) {
      this.textContent = Math.round(i(t));
    };
    });

  //Fade in categories
  chartRow.select(".category").transition()
    .duration(300)
    .attr("opacity",1);


  ////////
  //EXIT//
  ////////

  //Fade out and remove exit elements
  chartRow.exit().transition()
    .style("opacity","0")
    .attr("transform", "translate(0," + (height + margin.top + margin.bottom) + ")")
    .remove();


  ////////////////
  //REORDER ROWS//
  ////////////////

  var delay = function(d, i) { return 200 + i * 30; };

  chartRow.transition()
    .delay(delay)
    .duration(900)
    .attr("transform", function(d){ return "translate(0," + y(d.pageTitle) + ")"; });
};



//Pulls data
//Since our data is fake, adds some random changes to simulate a data stream.
//Uses a callback because d3.json loading is asynchronous
var pullData = function(settings,callback){
  
    var data=JSON.parse(result.results);
    var newData = data;
    data.forEach(function(d,i){
      var newValue = d.oms + Math.floor((Math.random()*5))
      console.log(newValue);
      newData[i].oms = newValue <= 0 ? 10 : newValue
    })

    newData = formatData(newData);

    callback(settings,newData);
}

//Sort data in descending order and take the top 10 values
var formatData = function(data){
    return data.sort(function (a, b) {
        return b.oms - a.oms;
      })
    .slice(0, 10);
}

//I like to call it what it does
var redraw = function(settings){
  pullData(settings,redrawChart)
}

//setup (includes first draw)
var settings = setup('#chart');
redraw(settings)

//Repeat every 3 seconds
setInterval(function(){
  redraw(settings)
}, 3000);

}
</script>
  <body>
  	<div class="container">
  		<h3>Clients</h3>
      </br>
  		<div id="clients-container" >
  		<select id="clients"><option>Loading clients...</option></select>
      </div>
  	  </br>
  		<div id="profiles-container"></div>
  	  </br>
  		<div id="views-container"></div>
  	  </br>
      <div id="reportrange" class="pull-right" style="background: #fff; cursor: pointer; padding: 5px; border: 1px solid #ccc">
       <i class="glyphicon glyphicon-calendar fa fa-calendar"></i>
      <span id="rangeValue"></span> <b class="caret"></b> </div>
       </br>
       <input type="button"id="runscore" class="button" name="button" value="Calculate Scores" onClick="runscore()">
       </br>
       <div id="scores-container"></div>
     </br>
		   <div id="d3-container"></div>
     </br>
        <div id="chart"></div>
     </br>
	</div>
</div>
  </body>
</html>
     